.section .text

ZETA_TABLE:
    .word 0, 25847, -2608894, -518909
    .word 237124, 1826347, 2353451, -777960
    .word -359251, -2091905, -876248, 3119733
    .word -2884855, 466468, 3111497, 2680103
    .word 2725464, 2706023, 95776, 1024112
    .word 3077325, 3530437, -1079900, -1661693
    .word -3592148, 3585928, -2537516, 3915439
    .word -549488, -3861115, -3043716, -1119584
    .word 3574422, -2867647, 2619752, 3539968
    .word -300467, -2108549, 2348700, -539299
    .word -2118186, -1699267, -1643818, -3859737
    .word 3505694, -3821735, -1399561, 3507263
    .word -2140649, -3277672, -1600420, 3699596
    .word 1757237, 811944, 531354, -19422
    .word 954230, 3881043, 4010497, 3900724
    .word -2556880, 280005, 2071892, -2797779
    .word -3930395, 2091667, 3407706, -1528703
    .word 2316500, 3817976, -3677745, -3342478
    .word 2244091, -3041255, -2446433, -3562462
    .word -1452451, 266997, 2434439, 3475950
    .word -1235728, 3513181, 2176455, -3520352
    .word -3759364, -1585221, -1197226, -3193378
    .word -1257611, 900702, 1859098, 1939314
    .word 909542, 819034, -4083598, 495491
    .word -1613174, -1000202, -43260, -522500
    .word -3190144, -655327, -3122442, -3157330
    .word 2031748, 3207046, -3632928, -3556995
    .word -525098, 126922, -768622, -3595838
    .word 3412210, 342297, 286988, -983419
    .word -2437823, 4108315, 2147896, 3437287
    .word -3342277, 2715295, 1735879, 203044
    .word -2967645, 2842341, 2691481, -3693493
    .word -2590150, 1265009, -411027, 4055324
    .word 1247620, -2477047, 2486353, 1595974
    .word -671102, -3767016, 1250494, -1228525
    .word 2635921, -3548272, -22981, -2994039
    .word 1869119, -1308169, 1903435, -1050970
    .word -381987, -1333058, 1237275, 1349076
    .word -3318210, -1430225, 1852771, -451100
    .word 1312455, -1430430, 3306115, -1962642
    .word -3343383, -1279661, 1917081, 264944
    .word -2546312, -1374803, 508951, 1500165
    .word 777191, 3097992, 2235880, 3406031
    .word 44288, -542412, -2831860, -1100098
    .word -1671176, -1846953, 904516, -2584293
    .word -3724270, 3958618, 594136, -3776993
    .word -3724342, -2013608, 2432395, -8578
    .word 2454455, -164721, 1653064, 1957272
    .word 3369112, -3249728, 185531, -1207385
    .word 2389356, -3183426, 162844, -210977
    .word 1616392, 3014001, 759969, 810149
    .word 1652634, -1316856, -3694233, -1799107
    .word 189548, -3038916, 3523897, -3553272
    .word 3866901, 269760, 3159746, 2213111
    .word -975884, -1851402, 1717735, 472078
    .word -2409325, -426683, 1723600, -177440
    .word -1803090, 1910376, 1315589, -1667432
    .word -1104333, 1341330, -260646, -3833893
    .word 1285669, -2939036, -2235985, -1584928
    .word -420899, -2286327, -812732, 183443
    .word -976891, -1439742, 1612842, -3545687
    .word -3019102, -554416, 3919660, -3881060
    .word -48306, -1362209, -3628969, 3937738
    .word 1400424, 3839961, -846154, 1976782

INV_ZETA_TABLE:
    .word -1976782, 846154, -3839961, -1400424
    .word -3937738, 3628969, 1362209, 48306    
    .word 3881060, -3919660, 554416, 3019102   
    .word 3545687, -1612842, 1439742, 976891   
    .word -183443, 812732, 2286327, 420899     
    .word 1584928, 2235985, 2939036, -1285669  
    .word 3833893, 260646, -1341330, 1104333   
    .word 1667432, -1315589, -1910376, 1803090 
    .word 177440, -1723600, 426683, 2409325    
    .word -472078, -1717735, 1851402, 975884   
    .word -2213111, -3159746, -269760, -3866901
    .word 3553272, -3523897, 3038916, -189548  
    .word 1799107, 3694233, 1316856, -1652634  
    .word -810149, -759969, -3014001, -1616392 
    .word 210977, -162844, 3183426, -2389356
    .word 1207385, -185531, 3249728, -3369112
    .word -1957272, -1653064, 164721, -2454455
    .word 8578, -2432395, 2013608, 3724342
    .word 3776993, -594136, -3958618, 3724270
    .word 2584293, -904516, 1846953, 1671176
    .word 1100098, 2831860, 542412, -44288
    .word -3406031, -2235880, -3097992, -777191
    .word -1500165, -508951, 1374803, 2546312
    .word -264944, -1917081, 1279661, 3343383
    .word 1962642, -3306115, 1430430, -1312455
    .word 451100, -1852771, 1430225, 3318210
    .word -1349076, -1237275, 1333058, 381987
    .word 1050970, -1903435, 1308169, -1869119
    .word 2994039, 22981, 3548272, -2635921
    .word 1228525, -1250494, 3767016, 671102
    .word -1595974, -2486353, 2477047, -1247620
    .word -4055324, 411027, -1265009, 2590150
    .word 3693493, -2691481, -2842341, 2967645
    .word -203044, -1735879, -2715295, 3342277
    .word -3437287, -2147896, -4108315, 2437823
    .word 983419, -286988, -342297, -3412210
    .word 3595838, 768622, -126922, 525098
    .word 3556995, 3632928, -3207046, -2031748
    .word 3157330, 3122442, 655327, 3190144
    .word 522500, 43260, 1000202, 1613174
    .word -495491, 4083598, -819034, -909542
    .word -1939314, -1859098, -900702, 1257611
    .word 3193378, 1197226, 1585221, 3759364
    .word 3520352, -2176455, -3513181, 1235728
    .word -3475950, -2434439, -266997, 1452451
    .word 3562462, 2446433, 3041255, -2244091
    .word 3342478, 3677745, -3817976, -2316500
    .word 1528703, -3407706, -2091667, 3930395
    .word 2797779, -2071892, -280005, 2556880
    .word -3900724, -4010497, -3881043, -954230
    .word 19422, -531354, -811944, -1757237
    .word -3699596, 1600420, 3277672, 2140649
    .word -3507263, 1399561, 3821735, -3505694
    .word 3859737, 1643818, 1699267, 2118186
    .word 539299, -2348700, 2108549, 300467
    .word -3539968, -2619752, 2867647, -3574422
    .word 1119584, 3043716, 3861115, 549488
    .word -3915439, 2537516, -3585928, 3592148
    .word 1661693, 1079900, -3530437, -3077325
    .word -1024112, -95776, -2706023, -2725464
    .word -2680103, -3111497, -466468, 2884855
    .word -3119733, 876248, 2091905, 359251
    .word 777960, -2353451, -1826347, -237124
    .word 518909, 2608894, -25847, 0

# return value is stored in VALH
# Q and QINV must be stored in registers
.macro montgomery_reduce VALH, VALL, TMP1, TMP2, Q, QINV
    mul     \TMP1, \VALL, \QINV     # t <- a * QINV
    mulh    \TMP2, \TMP1, \Q
    mul     \TMP1, \TMP1, \Q
    sub     \VALH, \VALH, \TMP2
    sltu    \TMP1, \VALL, \TMP1
    add     \VALH, \VALH, \TMP1
.endm

# Cooley-Tucky Butterfly
.macro ct_butterfly_core C0, C1, THI, TLO, Q, QINV, TMP0, TMP1, ZETA
    mulh    \THI, \C1, \ZETA        # t3: high / t4: low
    mul     \TLO, \C1, \ZETA        # zeta * a[j + len]

    # montgomery reduction
    mul     \TMP0, \TLO, \QINV     # t <- a * QINV
    mulh    \TMP1, \TMP0, \Q
    mul     \TMP0, \TMP0, \Q
    sub     \THI,  \THI,  \TMP1
    sltu    \TMP0, \TLO,  \TMP0
    add     \THI,  \THI,  \TMP0

    sub     \C1, \C0, \THI
    add     \C0, \C0, \THI
.endm


.macro gs_butterfly_core C0, C1, THI, TLO, Q, QINV, TMP0, TMP1, ZETA
    # lw      \TMP0, \OFFSET0(\A0)    # t <- a[j]
    mv      \TMP0, \C0
    add     \C0, \TMP0, \C1
    sub     \TMP0, \TMP0, \C1
D
    mulh    \C1, \TMP0, \ZETA
    mul     \TLO, \TMP0, \ZETA
    montgomery_reduce \C1, \TLO, \TMP0, \TMP1, \Q, \QINV
.endm


.global ntt
.align 2
.type ntt, @function
ntt:
    # push s registers into stack
    addi    sp, sp, -52
    sw      s0, 4(sp)
    sw      s1, 8(sp)
    sw      s2, 12(sp)
    sw      s3, 16(sp)
    sw      s4, 20(sp)
    sw      s5, 24(sp)
    sw      s6, 28(sp)
    sw      s7, 32(sp)
    sw      s8, 36(sp)
    sw      s9, 40(sp)
    sw      s10, 44(sp)
    sw      s11, 48(sp)

    # initialize zeta index, Q, QINV and loop counter
    li      s11, 0          # zeta index
    li      a6, 8380417     # Q
    li      a7, 58728449    # QINV
    li      t0, 128         # len
    la      a1, ZETA_TABLE

L1:
    srli    t6, t0, 1      # dist <- len / 2
    li      t1, 0   # start = 0

    L2:
        # load zetas
        addi    a1, a1, 4
        lw      t3, 0(a1)   # zeta0

        addi    a1, a1, 4
        lw      t4, 0(a1)   # zeta1

        addi    a1, a1, 4
        lw      t5, 0(a1)   # zeta2

        mv      t2, t1      # j <- start

        L3:
            # load coeffs
            mv      s10, a0     # coeff address

            slli    s9, t2, 2
            add     s10, s10, s9     # s10 <- a + j
            lw      s1, 0(s10)

            slli    s9, t0, 2
            add     s10, s10, s9    # s10 <- a + j + len
            lw      s3, 0(s10)      # caution: this is the third coeff

            slli    s9, t6, 2
            add     s10, s10, s9    # s10 <- a + j + len + dist
            lw      s4, 0(s10)     

            slli    s9, t0, 2
            sub     s10, s10, s9    # s10 <- a + j + dist
            lw      s2, 0(s10)

            # CT butterfly 1 layer
            ct_butterfly_core s1, s3, s5, s6, a6, a7, s7, s8, t3
            ct_butterfly_core s2, s4, s5, s6, a6, a7, s7, s8, t3

            # CT butterfly 2 layer
            ct_butterfly_core s1, s2, s5, s6, a6, a7, s7, s8, t4
            ct_butterfly_core s3, s4, s5, s6, a6, a7, s7, s8, t5

            # store coeffs
            mv      s10, a0     # coeff address

            slli    s9, t2, 2
            add     s10, s10, s9     # s10 <- a + j
            sw      s1, 0(s10)

            slli    s9, t0, 2
            add     s10, s10, s9    # s10 <- a + j + len
            sw      s3, 0(s10)      # caution: this is the third coeff

            slli    s9, t6, 2
            add     s10, s10, s9    # s10 <- a + j + len + dist
            sw      s4, 0(s10)     

            slli    s9, t0, 2
            sub     s10, s10, s9    # s10 <- a + j + dist
            sw      s2, 0(s10)

            # branch
            addi    t2, t2, 1
            add     s9, t1, t6  # s9 <- start + dist
            blt     t2, s9, L3

        mv      t1, t2
        add     t1, t1, t0
        add     t1, t1, t6  # start = j + len + dist
        li      s9, 256
        blt     t1, s9, L2
    
    srli    t0, t0, 2       # len >>= 2
    bgtz    t0, L1

    # restore zeta array address
    addi    a1, a1, -1020

    # pop stack
    lw      s0,  4(sp)
    lw      s1,  8(sp)
    lw      s2, 12(sp)
    lw      s3, 16(sp)
    lw      s4, 20(sp)
    lw      s5, 24(sp)
    lw      s6, 28(sp)
    lw      s7, 32(sp)
    lw      s8, 36(sp)
    lw      s9, 40(sp)
    lw      s10, 44(sp)
    lw      s11, 48(sp)
    addi    sp, sp, 52

    ret




.global intt
.align 2
.type intt, @function
intt:
    # push s registers into stack
    addi    sp, sp, -52
    sw      s0, 4(sp)
    sw      s1, 8(sp)
    sw      s2, 12(sp)
    sw      s3, 16(sp)
    sw      s4, 20(sp)
    sw      s5, 24(sp)
    sw      s6, 28(sp)
    sw      s7, 32(sp)
    sw      s8, 36(sp)
    sw      s9, 40(sp)
    sw      s10, 44(sp)
    sw      s11, 48(sp)

    # initialize zeta index, Q, QINV and loop counter
    li      s11, 0          # zeta index
    li      a6, 8380417     # Q
    li      a7, 58728449    # QINV
    li      t0, 1           # len
    li      t6, 256
    la      a1, INV_ZETA_TABLE
    li      s9, 41978       # f
    li      a3, 256         # N

iL1:
    srli    t6, t6, 1      # dist <- len / 2
    li      t1, 0          # start = 0

    iL2:
        # load zetas
        addi    a1, a1, 4
        lw      t3, 0(a1)   # zeta0

        addi    a1, a1, 4
        lw      t4, 0(a1)   # zeta1

        addi    a1, a1, 4
        lw      t5, 0(a1)   # zeta2

        mv      t2, t1      # j <- start

        iL3:
            # load coeffs
            mv      s10, a0     # coeff address

            slli    s9, t2, 2
            add     s10, s10, s9     # s10 <- a + j
            lw      s1, 0(s10)

            slli    s9, t0, 2
            add     s10, s10, s9    # s10 <- a + j + len
            lw      s3, 0(s10)      # caution: this is the third coeff

            slli    s9, t6, 2
            add     s10, s10, s9    # s10 <- a + j + len + dist
            lw      s4, 0(s10)     

            slli    s9, t0, 2
            sub     s10, s10, s9    # s10 <- a + j + dist
            lw      s2, 0(s10)

            # GS butterfly 1 layer
            gs_butterfly_core s1, s3, s5, s6, a6, a7, s7, s8, t3
            gs_butterfly_core s2, s4, s5, s6, a6, a7, s7, s8, t3

            # GS butterfly 2 layer
            gs_butterfly_core s1, s2, s5, s6, a6, a7, s7, s8, t4
            gs_butterfly_core s3, s4, s5, s6, a6, a7, s7, s8, t5

            # store coeffs
            mv      s10, a0     # coeff address

            slli    s9, t2, 2
            add     s10, s10, s9     # s10 <- a + j
            sw      s1, 0(s10)

            slli    s9, t0, 2
            add     s10, s10, s9    # s10 <- a + j + len
            sw      s3, 0(s10)      # caution: this is the third coeff

            slli    s9, t6, 2
            add     s10, s10, s9    # s10 <- a + j + len + dist
            sw      s4, 0(s10)     

            slli    s9, t0, 2
            sub     s10, s10, s9    # s10 <- a + j + dist
            sw      s2, 0(s10)

            # branch
            addi    t2, t2, 1
            add     s9, t1, t6  # s9 <- start + dist
            blt     t2, s9, iL3

        mv      t1, t2
        add     t1, t1, t0
        add     t1, t1, t6  # start = j + len + dist
        li      s9, 256
        blt     t1, s9, iL2
    
    slli    t0, t0, 2       # len <<= 2
    blt     t0, a3, iL1

    li      t0, 0
    li      s10, 0
MONT_L1:
    lw      s1, 0(s10)
    
    mulh    s3, s9, s1
    mul     s4, s9, s1
    montgomery_reduce s3, s4, s5, s6, a6, a7

    sw      s1, 0(s10)
    addi    s10, s10, 4

    addi    t0, t0, 1
    blt     t0, a3, MONT_L1

    # restore zeta array address
    addi    a1, a1, -1020

    # pop stack
    lw      s0,  4(sp)
    lw      s1,  8(sp)
    lw      s2, 12(sp)
    lw      s3, 16(sp)
    lw      s4, 20(sp)
    lw      s5, 24(sp)
    lw      s6, 28(sp)
    lw      s7, 32(sp)
    lw      s8, 36(sp)
    lw      s9, 40(sp)
    lw      s10, 44(sp)
    lw      s11, 48(sp)
    addi    sp, sp, 52

    ret